"use strict";(()=>{var e={};e.id=870,e.ids=[870],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7274:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>x,patchFetch:()=>h,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>c});var r={};a.r(r),a.d(r,{GET:()=>d,POST:()=>u});var s=a(9303),n=a(8716),i=a(670),o=a(7070),l=a(2331);async function d(e){try{let{searchParams:t}=new URL(e.url),a=t.get("userId"),r=t.get("email");if(!a&&!r)return o.NextResponse.json({error:"User ID or email required for data export"},{status:400});let s={exportDate:new Date().toISOString(),requestedBy:{userId:a,email:r},data:{}};if(a){let e=await l._.user.findUnique({where:{id:a},include:{talkPages:{include:{customGpts:!0,downloads:!0,businessLinks:!0,analytics:!0,emailCaptures:!0}}}});e&&(s.data.account={id:e.id,email:e.email,name:e.name,createdAt:e.createdAt,talkPages:e.talkPages.map(e=>({id:e.id,title:e.title,slug:e.slug,published:e.published,createdAt:e.createdAt,analytics:e.analytics,emailCaptures:e.emailCaptures.map(e=>({email:e.email,name:e.name,tier:e.tier,createdAt:e.createdAt}))}))})}let n=await l._.emailCapture.findMany({where:{email:r||void 0},include:{talkPage:{select:{title:!0,slug:!0}}}});n.length>0&&(s.data.emailCaptures=n.map(e=>({email:e.email,name:e.name,tier:e.tier,talkPage:e.talkPage,createdAt:e.createdAt})));let i=await l._.emailCaptureConsent.findMany({where:{email:r||void 0}});i.length>0&&(s.data.emailCaptureConsents=i.map(e=>({email:e.email,name:e.name,marketingConsent:e.marketingConsent,analyticsConsent:e.analyticsConsent,source:e.source,timestamp:e.timestamp})));let d=await l._.consentRecord.findMany({where:{OR:[{userId:a||void 0},{email:r||void 0}]},orderBy:{timestamp:"desc"}});if(d.length>0&&(s.data.consentRecords=d.map(e=>({preferences:e.preferences,timestamp:e.timestamp,version:e.version,source:e.source}))),a){let e=await l._.analytics.findMany({where:{talkPage:{userId:a}}});e.length>0&&(s.data.analytics=e.map(e=>({event:e.event,timestamp:e.createdAt})))}return new o.NextResponse(JSON.stringify(s,null,2),{headers:{"Content-Type":"application/json","Content-Disposition":`attachment; filename="micdrop-data-export-${Date.now()}.json"`}})}catch(e){return console.error("Error exporting user data:",e),o.NextResponse.json({error:"Failed to export user data"},{status:500})}}async function u(e){try{let{email:t,userId:a}=await e.json(),r=new URL("/api/user/data-export",e.url);return a&&r.searchParams.set("userId",a),t&&r.searchParams.set("email",t),o.NextResponse.json({message:"Data export queued",downloadUrl:r.toString()})}catch(e){return console.error("Error queuing data export:",e),o.NextResponse.json({error:"Failed to queue data export"},{status:500})}}let p=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/user/data-export/route",pathname:"/api/user/data-export",filename:"route",bundlePath:"app/api/user/data-export/route"},resolvedPagePath:"/Users/noahcheyer/MicDrop/app/api/user/data-export/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:c,serverHooks:g}=p,x="/api/user/data-export/route";function h(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:c})}},2331:(e,t,a)=>{a.d(t,{_:()=>s});var r=a(3524);let s=globalThis.prisma||new r.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[948,972],()=>a(7274));module.exports=r})();